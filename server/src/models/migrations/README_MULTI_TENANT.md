# Переход на мультитенантную структуру базы данных

## Общее описание изменений

В рамках перехода с однотенантной на мультитенантную структуру базы данных были внесены следующие изменения:

1. **Таблица предприятий (`Enterprises`)** - расширена для хранения API ключей и настроек интеграций с внешними сервисами (Wildberries и др.)
2. **Интеграции предприятий** - для каждого предприятия хранятся свои настройки интеграции с Wildberries, включая API ключи
3. **Таблицы данных** - все основные таблицы содержат поле `EnterpriseId`, которое связывает данные с конкретным предприятием
4. **Аутентификация и авторизация** - обновлены для учета привязки пользователя к предприятию и проверки прав доступа
5. **API маршруты** - обновлены для работы с разделением данных по предприятиям

## Структура базы данных

Основные изменения в структуре базы данных:
- Добавлено поле `EnterpriseId` во все таблицы, которые не имели этого поля
- Добавлены необходимые внешние ключи и индексы
- Созданы SQL-функции для проверки прав доступа к данным по предприятиям
- Расширена таблица `EnterpriseIntegrations` для хранения API ключей Wildberries

## Хранение API ключей Wildberries

В мультитенантной архитектуре API ключи Wildberries хранятся в базе данных для каждого предприятия:

1. В таблице `EnterpriseIntegrations` хранятся:
   - `ApiKey` - основной API ключ Wildberries
   - `WbKey` - дублирующее поле для совместимости (равно ApiKey)
   - `WbSupplierID` - ID поставщика в Wildberries (опционально)

2. API ключи используются в запросах к API Wildberries следующим образом:
   - При каждом запросе из контроллера извлекается API ключ нужного предприятия из БД
   - Ключ передается в HTTP-заголовках запроса
   - Если ключ отсутствует, используется тестовый ключ (только для разработки)

3. Никакие API ключи предприятий не хранятся в переменных окружения или конфигурациях

## Аутентификация и авторизация

1. В JWT-токены включена информация о предприятии
2. Добавлен middleware `authorizeEnterprise` для проверки прав доступа к данным
3. Обновлен механизм генерации и валидации токенов
4. Реализована проверка принадлежности пользователя к конкретному предприятию

## API интеграции

1. Обновлены маршруты API, добавлен параметр `enterpriseId` во все соответствующие маршруты
2. Обновлены контроллеры для работы с API для разных предприятий
3. Сервис синхронизации с WB API адаптирован для использования разных API ключей для разных предприятий
4. Добавлены новые методы для управления API ключами и настройками интеграции

## Миграция существующих данных

Для миграции существующих данных:

1. Создано первое предприятие с ID=1 (по умолчанию)
2. Написана функция `update_missing_enterprise_ids` для привязки существующих записей к первому предприятию
3. Добавлена поддержка возможности переноса данных между предприятиями (при необходимости)

## Безопасность

1. Добавлена изоляция данных между предприятиями на уровне базы данных
2. Каждый пользователь привязан к конкретному предприятию
3. API запросы к Wildberries выполняются с использованием ключа соответствующего предприятия
4. Реализована проверка прав доступа на уровне API запросов

## Последующие шаги

Для полного перехода на мультитенантную структуру необходимо выполнить следующие шаги:

1. Применить миграцию 010_update_multi_tenant.sql к базе данных
2. Обновить все остальные контроллеры по аналогии с `wb-api.controller.js`
3. Обновить все остальные маршруты по аналогии с `wb-api.js`
4. Дополнить логику проверки прав доступа в middleware
5. Обновить мобильное и веб-приложение для работы с новой структурой API

Внимание: Перед запуском миграции в производственной среде необходимо создать резервную копию базы данных. 