# API и интеграции

Документация по API и интеграциям проекта WB Assistant.

## Содержание
1. [Внутреннее API](#1-внутреннее-api)
2. [Интеграция с Wildberries API](#2-интеграция-с-wildberries-api)
3. [Система уведомлений](#3-система-уведомлений)
4. [Аутентификация и авторизация](#4-аутентификация-и-авторизация)
5. [Форматы данных](#5-форматы-данных)

## 1. Внутреннее API

### Базовая информация

- **Базовый URL:** `/api/v1`
- **Формат ответов:** JSON
- **Аутентификация:** JWT токены

### Основные эндпоинты

#### Управление пользователями

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| POST | `/auth/login` | Авторизация пользователя |
| POST | `/auth/refresh` | Обновление токена |
| GET | `/users` | Получение списка пользователей |
| GET | `/users/:id` | Получение информации о пользователе |
| POST | `/users` | Создание пользователя |
| PUT | `/users/:id` | Обновление информации пользователя |
| DELETE | `/users/:id` | Удаление пользователя |

#### Управление складом

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/warehouse/cells` | Получение списка ячеек склада |
| GET | `/warehouse/cells/:id` | Получение информации о ячейке |
| GET | `/warehouse/products` | Получение списка товаров на складе |
| GET | `/warehouse/products/:id` | Получение информации о товаре |
| POST | `/warehouse/products` | Добавление товара на склад |
| PUT | `/warehouse/products/:id` | Обновление информации о товаре |
| DELETE | `/warehouse/products/:id` | Удаление товара |

#### Управление поставками

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/shipments` | Получение списка поставок |
| GET | `/shipments/:id` | Получение информации о поставке |
| POST | `/shipments` | Создание новой поставки |
| PUT | `/shipments/:id` | Обновление информации о поставке |
| DELETE | `/shipments/:id` | Удаление поставки |
| GET | `/shipments/:id/orders` | Получение заказов в поставке |
| POST | `/shipments/:id/orders` | Добавление заказа в поставку |
| GET | `/shipments/:id/progress` | Получение прогресса сборки |
| POST | `/shipments/:id/complete` | Завершение поставки |

#### Управление заказами

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/orders` | Получение списка заказов |
| GET | `/orders/:id` | Получение информации о заказе |
| POST | `/orders` | Создание нового заказа |
| PUT | `/orders/:id` | Обновление информации о заказе |
| DELETE | `/orders/:id` | Удаление заказа |
| GET | `/orders/:id/items` | Получение товаров в заказе |
| POST | `/orders/:id/scan` | Сканирование товара для заказа |

#### Управление сменами

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| POST | `/shifts/start` | Начало смены |
| POST | `/shifts/end` | Окончание смены |
| GET | `/shifts/current` | Получение информации о текущей смене |
| GET | `/shifts/history` | Получение истории смен |
| GET | `/shifts/stats` | Получение статистики по сменам |

#### Инвентаризация

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/inventory/tasks` | Получение задач на инвентаризацию |
| GET | `/inventory/tasks/:id` | Получение информации о задаче |
| POST | `/inventory/tasks` | Создание задачи на инвентаризацию |
| PUT | `/inventory/tasks/:id` | Обновление задачи |
| POST | `/inventory/tasks/:id/scan` | Сканирование товара при инвентаризации |
| POST | `/inventory/tasks/:id/complete` | Завершение инвентаризации |

#### Аналитика и отчеты

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/reports/shipments` | Отчет по поставкам |
| GET | `/reports/workers` | Отчет по эффективности сборщиков |
| GET | `/reports/warehouse` | Отчет по заполненности склада |
| POST | `/reports/custom` | Создание пользовательского отчета |
| GET | `/analytics/dashboard` | Данные для панели управления |

### Примеры запросов и ответов

#### Авторизация

**Запрос:**
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "user@example.com",
  "password": "securepassword"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 123,
      "username": "user@example.com",
      "role": "manager",
      "name": "Иван Иванов"
    }
  }
}
```

#### Получение списка поставок

**Запрос:**
```http
GET /api/v1/shipments?status=in_progress
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "shipments": [
      {
        "id": "WB123456",
        "status": "in_progress",
        "ordersCount": 15,
        "completedOrdersCount": 8,
        "deadline": "2025-03-24T17:00:00Z",
        "assignedTo": {
          "id": 456,
          "name": "Петр Петров"
        }
      },
      {
        "id": "WB789012",
        "status": "in_progress",
        "ordersCount": 22,
        "completedOrdersCount": 0,
        "deadline": "2025-03-24T17:00:00Z",
        "assignedTo": null
      }
    ],
    "total": 2,
    "page": 1,
    "pageSize": 10
  }
}
```

## 2. Интеграция с Wildberries API

WB Assistant интегрируется с API Wildberries для синхронизации данных о товарах, заказах и поставках.

### Настройка интеграции

Для интеграции с Wildberries API необходимо получить API-ключ в личном кабинете поставщика Wildberries и указать его в настройках WB Assistant.

### Основные направления интеграции

#### Управление товарами

- Получение информации о товарах из каталога Wildberries
- Обновление остатков товаров
- Получение информации о ценах и скидках

#### Управление заказами

- Получение новых заказов от Wildberries
- Обновление статусов заказов
- Получение информации об отмененных заказах

#### Управление поставками

- Создание новых поставок в Wildberries
- Получение информации о существующих поставках
- Обновление статусов поставок

### Модуль синхронизации

Модуль синхронизации с Wildberries API выполняет следующие функции:

1. **Периодический опрос API** - получение обновлений через заданные промежутки времени
2. **Обработка Webhook** - прием уведомлений от Wildberries о событиях
3. **Обработка ошибок** - автоматическое повторение запросов при временных сбоях
4. **Логирование** - запись всех операций обмена с API для аудита и отладки

## 3. Система уведомлений

### Типы уведомлений

1. **Push-уведомления** - для мобильного приложения
2. **WebSocket-уведомления** - для веб-интерфейса
3. **Email-уведомления** - для важных событий

### Технические детали

#### Push-уведомления

- **Android**: Firebase Cloud Messaging (FCM)
- **iOS**: Apple Push Notification Service (APNS)

**Workflow:**
1. Устройство получает и регистрирует FCM/APNS токен
2. Токен передается на сервер и связывается с пользователем
3. Сервер отправляет уведомления через FCM/APNS

#### WebSocket-уведомления

- **Протокол**: WebSocket
- **Формат данных**: JSON

**Пример данных уведомления:**
```json
{
  "type": "shipment_assigned",
  "data": {
    "shipmentId": "WB123456",
    "ordersCount": 15,
    "deadline": "2025-03-24T17:00:00Z"
  },
  "timestamp": "2025-03-24T10:15:30Z"
}
```

### API уведомлений

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| GET | `/api/v1/notifications` | Получение списка уведомлений |
| PUT | `/api/v1/notifications/:id/read` | Отметка уведомления как прочитанного |
| PUT | `/api/v1/notifications/read-all` | Отметка всех уведомлений как прочитанных |
| POST | `/api/v1/devices/register` | Регистрация устройства для push-уведомлений |
| DELETE | `/api/v1/devices/:id` | Удаление регистрации устройства |
| GET | `/api/v1/notifications/settings` | Получение настроек уведомлений |
| PUT | `/api/v1/notifications/settings` | Обновление настроек уведомлений |

## 4. Аутентификация и авторизация

### JWT-токены

Аутентификация в API осуществляется с помощью JWT (JSON Web Tokens).

#### Формат токена

```
header.payload.signature
```

#### Содержимое payload

```json
{
  "sub": "user_id",
  "name": "Иван Иванов",
  "role": "manager",
  "iat": 1516239022,
  "exp": 1516242622
}
```

#### Процесс авторизации

1. Пользователь отправляет учетные данные (email/пароль)
2. Сервер проверяет данные и генерирует JWT-токен
3. Токен возвращается клиенту и сохраняется
4. Клиент отправляет токен в заголовке `Authorization` для последующих запросов
5. Для продления сессии используется refresh-токен

### Роли и разрешения

В системе предусмотрены следующие роли:

1. **admin** - полный доступ ко всем функциям
2. **manager** - управление поставками, заказами, пользователями
3. **worker** - выполнение задач по сборке, инвентаризации
4. **viewer** - только просмотр данных

Права доступа определяются на уровне API-эндпоинтов и проверяются middleware на сервере.

## 5. Форматы данных

### Общий формат ответа API

```json
{
  "success": true|false,
  "data": { ... },
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message",
    "details": { ... }
  },
  "meta": {
    "page": 1,
    "pageSize": 10,
    "total": 100
  }
}
```

### Формат даты и времени

Все даты и время передаются в формате ISO 8601 в UTC:

```
YYYY-MM-DDTHH:mm:ss.sssZ
```

Пример: `2025-03-24T14:30:00.000Z`

### Коды ошибок

| Код | Описание |
|-----|----------|
| AUTH_FAILED | Ошибка аутентификации |
| TOKEN_EXPIRED | Истек срок действия токена |
| ACCESS_DENIED | Доступ запрещен |
| RESOURCE_NOT_FOUND | Ресурс не найден |
| VALIDATION_ERROR | Ошибка валидации данных |
| INTERNAL_ERROR | Внутренняя ошибка сервера |
| INTEGRATION_ERROR | Ошибка интеграции с внешними системами | 